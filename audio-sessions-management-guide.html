<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Audio Sessions Management Guide  Reference</title>
    <link rel="stylesheet" type="text/css" href="css/jazzy.css" />
    <link rel="stylesheet" type="text/css" href="css/highlight.css" />
    <meta charset='utf-8'>
    <script src="js/jquery.min.js" defer></script>
    <script src="js/jazzy.js" defer></script>
    
  </head>
  <body>
    <a title="Audio Sessions Management Guide  Reference"></a>
    <header>
      <div class="content-wrapper">
        <p><a href="index.html"> Docs</a> (72% documented)</p>
        <p class="header-right"><a href="dash-feed://https%3A%2F%2Fstreamlayer%2Egithub%2Eio%2Fsdk%2Dios%2Fdocsets%2F%2Exml"><img src="img/dash.png"/>Install in Dash</a></p>
      </div>
    </header>
    <div class="content-wrapper">
      <p id="breadcrumbs">
        <a href="index.html"> Reference</a>
        <img id="carat" src="img/carat.png" />
        Audio Sessions Management Guide  Reference
      </p>
    </div>
    <div class="content-wrapper">
      <nav class="sidebar">
        <ul class="nav-groups">
          <li class="nav-group-name">
            <a href="Documentation.html">Documentation</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="about-streamlayer.html">About StreamLayer</a>
              </li>
              <li class="nav-group-task">
                <a href="architecture-overview.html">Architecture Overview</a>
              </li>
              <li class="nav-group-task">
                <a href="integration-guide.html">Integration Guide</a>
              </li>
              <li class="nav-group-task">
                <a href="constraints-guide.html">Constraints Guide</a>
              </li>
              <li class="nav-group-task">
                <a href="audio-sessions-management-guide.html">Audio Sessions Management Guide</a>
              </li>
              <li class="nav-group-task">
                <a href="overlay-visibility-handling-guide.html">Overlay Visibility Handling Guide</a>
              </li>
              <li class="nav-group-task">
                <a href="customize-text-messages-guide.html">Customize Text Messages Guide</a>
              </li>
              <li class="nav-group-task">
                <a href="sample-integrations.html">Sample Integrations</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Classes.html">Classes</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Classes/SLROverlayViewController.html">SLROverlayViewController</a>
              </li>
              <li class="nav-group-task">
                <a href="Classes/StreamLayer.html">StreamLayer</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Enums.html">Enumerations</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Enums/SLRAudioSessionType.html">SLRAudioSessionType</a>
              </li>
            </ul>
          </li>
          <li class="nav-group-name">
            <a href="Protocols.html">Protocols</a>
            <ul class="nav-group-tasks">
              <li class="nav-group-task">
                <a href="Protocols/SLROverlayDelegate.html">SLROverlayDelegate</a>
              </li>
            </ul>
          </li>
        </ul>
      </nav>
      <article class="main-content">
        <section>
          <section class="section">
            
            <h1 id='audio-sessions-management-guide' class='heading'>Audio Sessions Management Guide</h1>

<ul>
<li><a href="#audio-sessions-management-guide">Audio Sessions Management Guide</a></li>
<li><a href="#handling-audio-ducking">Handling Audio Ducking</a></li>
</ul>
<h1 id='handling-audio-ducking' class='heading'>Handling Audio Ducking</h1>

<p>Some overlays requires possibility to duck main video&rsquo;s audio session. For instance, the Twitter overlay may include video&rsquo;s in a twitter feed, which is playable. If we will not decrease (duck) main audio, the sound during twitter video playback will be overlap with it. If we provide the SDK methods to control our application&rsquo;s audio session, it will handle it smoothly decreasing the sound when needed. </p>

<p>These two methods are responsible for handling audio ducking:</p>

<ul>
<li><code><a href="Protocols/SLROverlayDelegate.html#/c:@M@StreamLayer@objc(pl)SLROverlayDelegate(im)requestAudioDucking">SLROverlayDelegate.requestAudioDucking(...)</a></code></li>
<li><code><a href="Protocols/SLROverlayDelegate.html#/c:@M@StreamLayer@objc(pl)SLROverlayDelegate(im)disableAudioDucking">SLROverlayDelegate.disableAudioDucking(...)</a></code></li>
</ul>

<p>Let&rsquo;s have a look on one of the possible way to implement audio ducking methods in delegate class.</p>
<pre class="highlight swift"><code><span class="kt">SLRVideoPlayer</span><span class="p">:</span> <span class="kt">SLROverlayDelegate</span> <span class="p">{</span>

<span class="o">...</span>

  <span class="kd">private</span> <span class="k">var</span> <span class="nv">player</span><span class="p">:</span> <span class="kt">AVPlayer</span><span class="o">!</span>

  <span class="c1">// tracks requests for ducking</span>
  <span class="kd">fileprivate</span> <span class="k">var</span> <span class="nv">volumeReductionRequests</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">fileprivate</span> <span class="k">let</span> <span class="nv">volumeReduceRate</span><span class="p">:</span> <span class="kt">Float</span> <span class="o">=</span> <span class="mf">0.02</span>
  <span class="kd">fileprivate</span> <span class="k">var</span> <span class="nv">playerVolumeOriginal</span><span class="p">:</span> <span class="kt">Float</span> <span class="o">=</span> <span class="mi">0</span>

<span class="o">...</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">requestAudioDucking</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">volumeReductionRequests</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">volumeReductionRequests</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="k">let</span> <span class="nv">player</span> <span class="o">=</span> <span class="n">player</span> <span class="p">{</span>
    <span class="n">playerVolumeOriginal</span> <span class="o">=</span> <span class="n">player</span><span class="o">.</span><span class="n">volume</span>
    <span class="n">player</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">volumeReduceRate</span>
    <span class="kt">SLRLog</span><span class="p">(</span><span class="nv">level</span><span class="p">:</span> <span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="s">"[ducking] on: </span><span class="se">\(</span><span class="n">volumeReduceRate</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">disableAudioDucking</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">volumeReductionRequests</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">volumeReductionRequests</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="k">let</span> <span class="nv">player</span> <span class="o">=</span> <span class="n">player</span> <span class="p">{</span>
    <span class="n">player</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="n">playerVolumeOriginal</span>
    <span class="kt">SLRLog</span><span class="p">(</span><span class="nv">level</span><span class="p">:</span> <span class="o">.</span><span class="n">info</span><span class="p">,</span> <span class="s">"[ducking] off: </span><span class="se">\(</span><span class="n">playerVolumeOriginal</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="o">...</span>


<span class="p">}</span>
</code></pre>

<p>Audio notifications are used by the SDK in various ways. They used for voice chat, messaging and other features. There is a limitation in the iOS platform which allows each application to use only one audio session, hence the host app and the SDK use the same audio session.   </p>

<p>To minimize interference between host app&rsquo;s and SDK&rsquo;s audio modes following delegate methods have to be implemented:</p>

<ul>
<li><code><a href="Protocols/SLROverlayDelegate.html#/c:@M@StreamLayer@objc(pl)SLROverlayDelegate(im)prepareAudioSessionFor:">SLROverlayDelegate.prepareAudioSession(...)</a></code></li>
<li><code><a href="Protocols/SLROverlayDelegate.html#/c:@M@StreamLayer@objc(pl)SLROverlayDelegate(im)disableAudioSessionFor:">SLROverlayDelegate.disableAudioSession(...)</a></code></li>
</ul>

<p>And here is an example of possible implementation</p>
<pre class="highlight swift"><code><span class="kt">SLRVideoPlayer</span><span class="p">:</span> <span class="kt">SLROverlayDelegate</span> <span class="p">{</span>

<span class="o">...</span>

  <span class="c1">// tracks requests for audio sessions</span>
  <span class="kd">fileprivate</span> <span class="k">var</span> <span class="nv">kTotalSessions</span><span class="p">:</span> <span class="kt">Int</span> <span class="p">{</span> <span class="k">return</span> <span class="n">kGenericSessions</span> <span class="o">+</span> <span class="n">kGenericSessions</span> <span class="p">}</span>
  <span class="kd">fileprivate</span> <span class="k">var</span> <span class="nv">kGenericSessions</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="kd">fileprivate</span> <span class="k">var</span> <span class="nv">kVoiceSessions</span><span class="p">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">0</span>

<span class="o">...</span>

 <span class="kd">@discardableResult</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">enableVoiceAudioSession</span><span class="p">(</span><span class="nv">reactivate</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="k">guard</span> <span class="kt">SLRRequestPermissionManager</span><span class="o">.</span><span class="nf">microphoneAccessGranted</span><span class="p">()</span> <span class="o">==</span> <span class="o">.</span><span class="n">granted</span> <span class="k">else</span> <span class="p">{</span>
      <span class="nf">assertionFailure</span><span class="p">(</span><span class="s">"NO PERMISSION TO MIC"</span><span class="p">)</span>
      <span class="c1">// Note: you may show an alert with request to get microphone access here</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>

    <span class="k">let</span> <span class="nv">audioSession</span> <span class="o">=</span> <span class="kt">AVAudioSession</span><span class="o">.</span><span class="nf">sharedInstance</span><span class="p">()</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="cp">#if os(iOS)</span>
      <span class="k">try</span> <span class="n">audioSession</span><span class="o">.</span><span class="nf">setCategory</span><span class="p">(</span><span class="o">.</span><span class="n">playAndRecord</span><span class="p">,</span>
                                   <span class="nv">mode</span><span class="p">:</span> <span class="o">.</span><span class="n">voiceChat</span><span class="p">,</span>
                                   <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">defaultToSpeaker</span><span class="p">,</span> <span class="o">.</span><span class="n">interruptSpokenAudioAndMixWithOthers</span><span class="p">])</span>

      <span class="k">if</span> <span class="n">reactivate</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">audioSession</span><span class="o">.</span><span class="nf">setActive</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
      <span class="p">}</span>
      <span class="cp">#endif</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">true</span>
  <span class="p">}</span>

  <span class="kd">@discardableResult</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">enableGenericAudioSession</span><span class="p">(</span><span class="nv">reactivate</span><span class="p">:</span> <span class="kt">Bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">audioSession</span> <span class="o">=</span> <span class="kt">AVAudioSession</span><span class="o">.</span><span class="nf">sharedInstance</span><span class="p">()</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="k">try</span> <span class="n">audioSession</span><span class="o">.</span><span class="nf">setCategory</span><span class="p">(</span><span class="o">.</span><span class="n">playback</span><span class="p">,</span> <span class="nv">mode</span><span class="p">:</span> <span class="o">.</span><span class="n">moviePlayback</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="p">[</span><span class="o">.</span><span class="n">duckOthers</span><span class="p">])</span>
      <span class="k">if</span> <span class="n">reactivate</span> <span class="p">{</span>
        <span class="k">try</span> <span class="n">audioSession</span><span class="o">.</span><span class="nf">setActive</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="p">{</span>
      <span class="c1">// Note: handle error here as you usually do in your app</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">true</span>
  <span class="p">}</span>

  <span class="kd">@discardableResult</span>
  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">disableAudioSession</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">Bool</span> <span class="p">{</span>
    <span class="k">let</span> <span class="nv">audioSession</span> <span class="o">=</span> <span class="kt">AVAudioSession</span><span class="o">.</span><span class="nf">sharedInstance</span><span class="p">()</span>
    <span class="k">do</span> <span class="p">{</span>
      <span class="kt">SLRLog</span><span class="p">(</span><span class="nv">level</span><span class="p">:</span> <span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="s">"GOING TO DISABLE AUDIO"</span><span class="p">)</span>
      <span class="k">try</span> <span class="n">audioSession</span><span class="o">.</span><span class="nf">setActive</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="nv">options</span><span class="p">:</span> <span class="o">.</span><span class="n">notifyOthersOnDeactivation</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">catch</span> <span class="k">let</span> <span class="nv">error</span> <span class="p">{</span>
      <span class="kt">SLRLog</span><span class="p">(</span><span class="nv">level</span><span class="p">:</span> <span class="o">.</span><span class="n">error</span><span class="p">,</span> <span class="s">"Disabling generic audio failed. err: </span><span class="se">\(</span><span class="n">error</span><span class="se">)</span><span class="s">"</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">false</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="kc">true</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">disableAudioSession</span><span class="p">(</span><span class="k">for</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">SLRAudioSessionType</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">type</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">voice</span><span class="p">:</span> <span class="n">kVoiceSessions</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">generic</span><span class="p">:</span> <span class="n">kGenericSessions</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="p">}</span>

    <span class="c1">// no sessions at all - disable</span>
    <span class="k">if</span> <span class="n">kTotalSessions</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="nf">disableAudioSession</span><span class="p">()</span>
      <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">kVoiceSessions</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
      <span class="k">return</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="o">.</span><span class="n">voice</span> <span class="p">{</span>
      <span class="nf">enableGenericAudioSession</span><span class="p">(</span><span class="nv">reactivate</span><span class="p">:</span> <span class="kc">false</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kd">public</span> <span class="kd">func</span> <span class="nf">prepareAudioSession</span><span class="p">(</span><span class="k">for</span> <span class="nv">type</span><span class="p">:</span> <span class="kt">SLRAudioSessionType</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">type</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">.</span><span class="nv">voice</span><span class="p">:</span>
      <span class="n">kVoiceSessions</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">kVoiceSessions</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">{</span>
        <span class="nf">enableVoiceAudioSession</span><span class="p">(</span><span class="nv">reactivate</span><span class="p">:</span> <span class="kc">true</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="p">}</span>

    <span class="k">case</span> <span class="o">.</span><span class="nv">generic</span><span class="p">:</span>
      <span class="n">kGenericSessions</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">kGenericSessions</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">kVoiceSessions</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="k">let</span> <span class="nv">reactivate</span> <span class="o">=</span> <span class="n">kGenericSessions</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nf">enableGenericAudioSession</span><span class="p">(</span><span class="nv">reactivate</span><span class="p">:</span> <span class="n">reactivate</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">player</span><span class="p">?</span><span class="o">.</span><span class="nf">play</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="k">return</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>

<span class="o">...</span>


<span class="p">}</span>
</code></pre>

          </section>
        </section>
        <section id="footer">
          <p>&copy; 2020 <a class="link" href="" target="_blank" rel="external">StreamLayer</a>. All rights reserved. (Last updated: 2020-05-12)</p>
          <p>Generated by <a class="link" href="https://github.com/realm/jazzy" target="_blank" rel="external">jazzy ♪♫ v0.13.2</a>, a <a class="link" href="https://realm.io" target="_blank" rel="external">Realm</a> project.</p>
        </section>
      </article>
    </div>
  </body>
</div>
</html>
